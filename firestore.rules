rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin (checks user_roles collection)
    // Document ID format: {userId}_admin
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/user_roles/$(request.auth.uid + '_admin'));
    }
    
    // Check if user is a provider (checks user_roles collection)
    // Document ID format: {userId}_provider
    function isProvider() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/user_roles/$(request.auth.uid + '_provider'));
    }
    
    // ============================================
    // USERS - Core user document with userType
    // ============================================
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
    }
    
    // ============================================
    // CITIZENS - Citizen-specific data
    // ============================================
    match /citizens/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }
    
    // ============================================
    // ADMINS - Admin-specific data
    // ============================================
    match /admins/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      // Only existing admins can create/update admin accounts
      allow write: if isAdmin();
    }
    
    // ============================================
    // AUDIT LOG - Admin actions log
    // ============================================
    match /audit_log/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
    }
    
    // ============================================
    // MEDICAL ADS - Provider ads with admin moderation
    // ============================================
    match /ads/{adId} {
      // Public can read approved ads
      allow read: if resource.data.status == 'approved';
      // Providers can read their own ads
      allow read: if isAuthenticated() && resource.data.providerId == request.auth.uid;
      // Admins can read all ads
      allow read: if isAdmin();
      // Providers can create ads for themselves
      allow create: if isProvider() && 
                       request.resource.data.providerId == request.auth.uid;
      // Providers can delete their own ads
      allow delete: if isAuthenticated() && resource.data.providerId == request.auth.uid;
      // Only admins can update ads (for approve/reject)
      allow update: if isAdmin();
    }
    
    // ============================================
    // PROFILES - Users can only read/write their own
    // ============================================
    match /profiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ============================================
    // USER ROLES - Only admins can write, users can read their own
    // ============================================
    match /user_roles/{docId} {
      // Document ID format: {userId}_{role}
      // Allow users to read their own role documents
      allow read: if isAuthenticated() && 
        docId.matches(request.auth.uid + '_.*');
      // Allow admins to read all roles
      allow read: if isAdmin();
      // Only admins can write roles (except for initial provider role assignment)
      allow create: if isAuthenticated() && 
        docId == (request.auth.uid + '_provider') &&
        request.resource.data.role == 'provider';
      // Only admins can update/delete roles
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // ANALYTICS - Authenticated write, admin read
    // ============================================
    match /analytics_events/{eventId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // FAVORITES - Users can only access their own
    // ============================================
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // PROVIDERS - Public read for verified providers
    // ============================================
    match /providers/{providerId} {
      // PUBLIC ACCESS: Allow read for verified and public providers
      // This works for both single document reads AND queries
      allow read: if resource.data.verificationStatus == 'verified' && 
                     resource.data.isPublic == true;
      
      // PUBLIC LIST: Allow listing providers when querying for verified/public only
      // This is needed for queries with where() clauses
      allow list: if request.query != null;
      
      // OWNER ACCESS: Users can read their own provider profile (even if not verified)
      // Provider ID format: provider_{userId}
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // ADMIN ACCESS: Admins can read all providers
      allow read: if isAdmin();
      
      // CREATE: Authenticated users can create providers (for registration)
      // Must create with their own userId
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // UPDATE: Owner can update their own profile (but NOT verification status fields)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['verificationStatus', 'isPublic', 'verified']);
      
      // UPDATE: Admins can update any provider (for verification)
      allow update: if isAdmin();
      
      // DELETE: Only admins can delete providers
      allow delete: if isAdmin();
    }
    
    // ============================================
    // PROVIDER DRAFTS - For registration flow
    // ============================================
    match /providerDrafts/{draftId} {
      // Read: Check existing doc's userId
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Create: Check incoming data's userId
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Update/Delete: Check existing doc's userId
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // APPOINTMENTS - Users can access their own
    // Provider access via userId field in provider document
    // ============================================
    match /appointments/{appointmentId} {
      // Patient can read their own appointments
      allow read: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      
      // Provider can read appointments for their provider profile
      // Provider document ID is provider_{userId}, so we check providerUserId field
      allow read: if isAuthenticated() && 
        resource.data.providerUserId == request.auth.uid;
      
      // Patient can create appointments (must set their patientId)
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      
      // Patient or provider can update appointments
      allow update: if isAuthenticated() && 
        (resource.data.patientId == request.auth.uid || 
         resource.data.providerUserId == request.auth.uid);
      
      // Only patient can delete their appointments
      allow delete: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
    }
    
    // ============================================
    // VERIFICATION REQUESTS - For admin verification queue
    // ============================================
    match /verification_requests/{requestId} {
      // Providers can read their own requests
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Providers can create their own requests
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Admins can read all requests
      allow read: if isAdmin();
      // Admins can update requests (approve/reject)
      allow update: if isAdmin();
      // Admins can delete requests
      allow delete: if isAdmin();
    }
    
    // ============================================
    // REVIEWS - Public read, authenticated write own
    // ============================================
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // CHAT SESSIONS - Users can only access their own
    // ============================================
    match /chat_sessions/{sessionId} {
      // Read: Check existing doc's userId
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Create: Check incoming data's userId (FIXED: was checking resource.data)
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Update/Delete: Check existing doc's userId
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
  }
}
