rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin (checks user_roles collection)
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ============================================
    // PROFILES - Users can only read/write their own
    // ============================================
    match /profiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ============================================
    // USER ROLES - Only admins can write, users can read their own
    // ============================================
    match /user_roles/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin();
    }
    
    // ============================================
    // ANALYTICS - Authenticated write, admin read
    // ============================================
    match /analytics_events/{eventId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // FAVORITES - Users can only access their own
    // ============================================
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // PROVIDERS - Public read for verified providers
    // ============================================
    match /providers/{providerId} {
      // PUBLIC ACCESS: Allow read for verified and public providers
      // For queries: the query must include where('verificationStatus', '==', 'verified') 
      // AND where('isPublic', '==', true) for this rule to apply
      allow read: if resource.data.verificationStatus == 'verified' && 
                     resource.data.isPublic == true;
      
      // OWNER ACCESS: Users can read their own provider profile (even if not verified)
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // ADMIN ACCESS: Admins can read all providers
      allow read: if isAdmin();
      
      // CREATE: Authenticated users can create providers (for registration)
      allow create: if isAuthenticated();
      
      // UPDATE: Owner can update their own profile
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // UPDATE: Admins can update any provider (for verification)
      allow update: if isAdmin();
      
      // DELETE: Only admins can delete providers
      allow delete: if isAdmin();
    }
    
    // ============================================
    // PROVIDER DRAFTS - For registration flow
    // ============================================
    match /providerDrafts/{draftId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // APPOINTMENTS - Users can access their own
    // ============================================
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated() && 
        (resource.data.patientId == request.auth.uid || 
         resource.data.providerId == request.auth.uid);
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && 
        (resource.data.patientId == request.auth.uid || 
         resource.data.providerId == request.auth.uid);
      allow delete: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
    }
    
    // ============================================
    // REVIEWS - Public read, authenticated write own
    // ============================================
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // CHAT SESSIONS - Users can only access their own
    // ============================================
    match /chat_sessions/{sessionId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
  }
}
